<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login - Institución Educativa</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="login.css" rel="stylesheet">
</head>

<body class="background-page">
    <!-- Modifica el contenedor principal para mejor responsive -->
    <div class="container-fluid login-container px-3"> <!-- Añadido px-3 para padding en móviles -->
        <div class="row justify-content-center mx-0"> <!-- mx-0 para eliminar margen horizontal -->
            <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 px-0"> <!-- px-0 para eliminar padding -->
                <form id="loginForm" class="custom-form glassmorphism-effect">
                    <p id="heading">Bienvenido</p>
                    <p class="institution-name">Institución Educativa Héctor Abad Gómez</p>

                    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="errorText"></span>
                    </div>

                    <div class="field">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z" />
                        </svg>
                        <input autocomplete="off" placeholder="Correo Electrónico" class="input-field" id="email"
                            type="email" required>
                    </div>

                    <div class="field">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                        </svg>
                        <input placeholder="Contraseña" class="input-field" id="password" type="password" required>
                        <button class="btn-toggle-pass" type="button" id="passwordToggle">
                            <i class="bi bi-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>

                    <div class="options-row">
                        <div class="checkbox-container">
                            <input type="checkbox" id="rememberMe">
                            <label for="rememberMe">Recuérdame</label>
                        </div>
                    </div>

                    <div class="btn-group-vertical w-100 gap-2">
                        <button type="submit" class="button1" id="loginButton">
                            <span class="button-text">Iniciar Sesión</span>
                            <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
                        </button>
                        <button type="button" class="button-test" id="testLoginBtn">
                            <i class="bi bi-shield-lock me-2"></i>Acceso Rápido (Docente)
                        </button>
                    </div>

                    <div class="form-footer">
                        <div class="footer-left">
                            <button type="button" class="button3" id="forgotPasswordBtn">¿Olvidaste tu
                                contraseña?</button>
                        </div>
                        <div class="footer-right">
                            <a href="register.html" class="button3">¿No tienes cuenta? Regístrate</a>
                        </div>
                    </div>


                </form>
            </div>
        </div>
    </div>

    <!-- Modal Recuperar Contraseña -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glassmorphism-effect">
                <div class="modal-header">
                    <h5 class="modal-title">Recuperar Contraseña</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="forgotPasswordForm">
                        <div class="mb-3">
                            <label for="recoveryEmail" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control dark-input" id="recoveryEmail" required>
                        </div>
                        <button type="submit" class="button1 w-100">
                            <span id="recoveryButtonText">Enviar Enlace</span>
                            <span class="spinner-border spinner-border-sm d-none" id="recoverySpinner"></span>
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button3" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script>
        // Esperar a que el DOM y los scripts estén cargados
        window.addEventListener('load', function () {
            // Esperar un momento adicional para asegurar que auth.js esté completamente cargado
            setTimeout(function () {
                initializeLogin();
            }, 100);
        });

        function initializeLogin() {
            // Verificar que las funciones estén disponibles
            if (!window.loginUser) {
                console.error('❌ loginUser no está disponible');
                // Intentar usar window.auth como fallback
                if (window.auth && window.auth.loginUser) {
                    window.loginUser = window.auth.loginUser;
                    window.logoutUser = window.auth.logoutUser;
                    window.recoverPassword = window.auth.recoverPassword;
                } else {
                    alert('Error: Las funciones de autenticación no están disponibles. Por favor recarga la página.');
                    return;
                }
            }

            console.log('✅ Inicializando formulario de login...');

            // Toggle Password Visibility
            const passwordToggle = document.getElementById('passwordToggle');
            if (passwordToggle) {
                passwordToggle.addEventListener('click', function () {
                    const passwordInput = document.getElementById('password');
                    const icon = document.getElementById('passwordToggleIcon');
                    if (passwordInput && icon) {
                        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                        icon.classList.toggle('bi-eye');
                        icon.classList.toggle('bi-eye-slash');
                    }
                });
            }

            // Login Form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const loginButton = document.getElementById('loginButton');
                    const spinner = document.getElementById('loginSpinner');
                    const errorMessage = document.getElementById('errorMessage');
                    const buttonText = document.querySelector('.button-text');

                    if (!email || !password) {
                        if (errorMessage) {
                            errorMessage.classList.remove('d-none');
                            const errorText = document.getElementById('errorText');
                            if (errorText) {
                                errorText.textContent = "Por favor complete todos los campos";
                            } else {
                                errorMessage.textContent = "Por favor complete todos los campos";
                            }
                        }
                        return;
                    }

                    if (loginButton) loginButton.disabled = true;
                    if (spinner) spinner.classList.remove('d-none');
                    if (buttonText) buttonText.classList.add('d-none');
                    if (errorMessage) errorMessage.classList.add('d-none');

                    try {
                        const loginFn = window.loginUser || (window.auth && window.auth.loginUser);
                        if (!loginFn) {
                            throw new Error('Función de login no disponible');
                        }
                        await loginFn(email, password);
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Error en login:', error);
                        if (errorMessage) {
                            errorMessage.classList.remove('d-none');
                            const errorText = document.getElementById('errorText');
                            if (errorText) {
                                errorText.textContent = error.message || "Error al iniciar sesión";
                            } else {
                                errorMessage.textContent = error.message || "Error al iniciar sesión";
                            }
                        }
                    } finally {
                        if (loginButton) loginButton.disabled = false;
                        if (spinner) spinner.classList.add('d-none');
                        if (buttonText) buttonText.classList.remove('d-none');
                    }
                });
            }

            // Forgot Password
            const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
            if (forgotPasswordBtn) {
                forgotPasswordBtn.addEventListener('click', function () {
                    const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
                    modal.show();
                });
            }

            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            if (forgotPasswordForm) {
                forgotPasswordForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const email = document.getElementById('recoveryEmail').value;
                    const buttonText = document.getElementById('recoveryButtonText');
                    const spinner = document.getElementById('recoverySpinner');

                    if (buttonText) buttonText.classList.add('d-none');
                    if (spinner) spinner.classList.remove('d-none');

                    try {
                        const recoverFn = window.recoverPassword || (window.auth && window.auth.recoverPassword);
                        if (!recoverFn) {
                            throw new Error('Función de recuperación no disponible');
                        }
                        await recoverFn(email);
                        alert('Enlace de recuperación enviado a tu correo');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
                        if (modal) modal.hide();
                    } catch (error) {
                        alert('Error: ' + error.message);
                    } finally {
                        if (buttonText) buttonText.classList.remove('d-none');
                        if (spinner) spinner.classList.add('d-none');
                    }
                });
            }

            // Quick Access Button
            const testLoginBtn = document.getElementById('testLoginBtn');
            if (testLoginBtn) {
                testLoginBtn.addEventListener('click', function () {
                    document.getElementById('email').value = 'appsdocentes@iehectorabadgomez.edu.co';
                    document.getElementById('password').value = 'Master2025';
                    loginForm.dispatchEvent(new Event('submit'));
                });
            }
        }
    </script>
</body>

</html>